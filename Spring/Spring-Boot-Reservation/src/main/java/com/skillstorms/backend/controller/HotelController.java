package com.skillstorms.backend.controller;

import java.time.LocalDate;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Optional;

import javax.validation.Valid;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.ResponseStatus;
import org.springframework.web.bind.annotation.RestController;

import com.skillstorms.backend.model.CityState;
import com.skillstorms.backend.model.Customer;
import com.skillstorms.backend.model.Hotel;
import com.skillstorms.backend.model.ResourceNotFoundException;
import com.skillstorms.backend.repository.HotelRepository;
import com.skillstorms.backend.service.HotelService;

@RestController // @RestController = @Controller + @ResponseBody
@CrossOrigin(origins = "*")
@RequestMapping(path="/hotel") // This means URL's start with /demo (after Application path)
public class HotelController {
  @Autowired // This means to get the bean called userRepository
         // Which is auto-generated by Spring, we will use it to handle the data
  private HotelRepository hotelRepository;
  @Autowired
  private HotelService hotelService;
  
  @PostMapping
  public Hotel create(@Valid @RequestBody Hotel hotel) {
	return hotelRepository.save(hotel);
  }

  @GetMapping(path="/all")
  public @ResponseBody Iterable<Hotel> getAllCustomers() {
    return hotelRepository.findAll();
  }
  
  @GetMapping(path="/{hotelId}")
  public Hotel findByID(@PathVariable (value = "hotelId") int hotelID) {
	  	Optional<Hotel> hotel = hotelRepository.findById(hotelID);
		return hotel.isPresent() ? hotel.get() : null;
  }
  
  @GetMapping(path="/statecity")
  public @ResponseBody ArrayList<CityState> getStateAndCity() {
	  Iterable<Hotel> hotel = hotelRepository.findAll();
	    HashMap<String, String> cities = new HashMap<String, String>();

      int n = 10; 

	  ArrayList<CityState> arr = new ArrayList<CityState>(n);	  
	  hotel.forEach((element) -> { 
		  CityState temp = new CityState();
		  String city = element.getCity();
		  String state = element.getState();
		  String key = city+state;
		  if ( cities.put(key, city) == null) {
			  temp.setCity(city);
			  temp.setState(state);
			  arr.add(temp);
		  }
	  });
	  return arr;
  }
  
  @GetMapping(path="/name/{name}")
  public @ResponseBody List<Hotel> findByName(@PathVariable String name) {
  	return hotelRepository.findByHotelName(name);
  }
  
  //update	
  @PutMapping(path="/{id}")
  public @ResponseBody Optional<Object> update(@PathVariable (value = "id") int hotelID, @Valid @RequestBody Hotel newHotel) { 
	  return hotelRepository.findById(hotelID)
		      .map(hotel -> {
		    	  hotel.setHotelName(newHotel.getHotelName());
		    	  hotel.setCity(newHotel.getCity());
		    	  hotel.setStreet(newHotel.getStreet());
		    	  hotel.setState(newHotel.getState());
		    	  hotel.setZipcode(newHotel.getZipcode());
		    	  hotel.setPhone(newHotel.getPhone());
		    	  hotel.setTotalRoom(newHotel.getTotalRoom());
		    	  hotel.setRating(newHotel.getRating());
		    	  hotel.setPrice(newHotel.getPrice());
		    	  hotel.setDescription(newHotel.getDescription());
		          return hotelRepository.save(hotel);
	 });
  }
  //delete
  @DeleteMapping(path="/{id}")
  @ResponseStatus(code = HttpStatus.OK)
  public void delete(@PathVariable int id) {
  	hotelRepository.deleteById(id);
  }
  
  @GetMapping(path="/location")
  public @ResponseBody List<Hotel> findHotelsByCityAndState(
  		@RequestParam(name="city", defaultValue="") String city, 
  		@RequestParam(name="state", defaultValue="") String state) {
  	return hotelService.findByCityAndState(city, state);
  }
  
  @GetMapping(path="/search")
  public @ResponseBody List<Hotel> findHotelsByCityStateAndDate(
  		@RequestParam(name="city", defaultValue="") String city, 
  		@RequestParam(name="state", defaultValue="") String state,
  		@RequestParam(name="arrival-date") String arrivalDate,
  		@RequestParam(name="depart-date") String departDate) {
  	LocalDate arrival = LocalDate.parse(arrivalDate);
  	LocalDate depart = LocalDate.parse(departDate);
  	return hotelService.findByCityStateAndAvailability(city, state, arrival, depart);
  }
  
  
}

